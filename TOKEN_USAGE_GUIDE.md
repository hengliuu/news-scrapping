# Token Usage Tracking Guide

## Overview

The News Scrapping Service now tracks and displays token usage for all Gemini AI API calls, helping you monitor API consumption and costs.

## What's Tracked

- **Input Tokens**: Number of tokens in the prompt sent to Gemini (includes scraped articles and instructions)
- **Output Tokens**: Number of tokens in Gemini's response (the curated news selection)
- **Total Tokens**: Sum of input and output tokens

## Where Token Usage is Displayed

### 1. Discord Messages
Every news update sent to Discord includes token usage statistics in the footer:

```
ðŸ“Š Token Usage: Input: 2456 | Output: 512 | Total: 2968
```

This appears below the news items and bot signature.

### 2. API Responses
The `/api/v1/latest` endpoint includes token usage in the response:

```json
{
  "message": "Latest news retrieved successfully",
  "data": {
    "news": [...],
    "token_usage": {
      "input_tokens": 2456,
      "output_tokens": 512,
      "total_tokens": 2968
    }
  }
}
```

### 3. Application Logs
Token usage is logged for each AI processing:

```
Token usage - Input: 2456, Output: 512, Total: 2968
```

## Monitoring Token Usage

### Quick Check with CURL
```bash
# Get latest news with token usage
curl -s http://localhost:6005/api/v1/latest | jq '.data.token_usage'

# Output:
{
  "input_tokens": 2456,
  "output_tokens": 512,
  "total_tokens": 2968
}
```

### Compare AI vs Global News Token Usage
```bash
# AI news tokens
curl -s "http://localhost:6005/api/v1/latest?type=ai" | jq '.data.token_usage.total_tokens'

# Global news tokens
curl -s "http://localhost:6005/api/v1/latest?type=global" | jq '.data.token_usage.total_tokens'
```

### Track Usage Over Time
```bash
# Simple monitoring script
#!/bin/bash
while true; do
    USAGE=$(curl -s http://localhost:6005/api/v1/latest | jq '.data.token_usage')
    echo "$(date): $USAGE"
    sleep 3600  # Check every hour
done
```

## Token Usage Patterns

### Typical Token Counts

- **AI News Processing**:
  - Input: 2000-3000 tokens (depends on number of scraped articles)
  - Output: 400-600 tokens (curated top 5 news)
  - Total: 2400-3600 tokens per request

- **Global News Processing**:
  - Input: 2500-4000 tokens (more diverse sources)
  - Output: 500-700 tokens (broader summaries)
  - Total: 3000-4700 tokens per request

### Factors Affecting Token Usage

1. **Number of Sources**: More news sources = more input tokens
2. **Article Length**: Longer summaries in RSS feeds increase input tokens
3. **Prompt Complexity**: Type-specific prompts may vary slightly
4. **Response Format**: JSON structure adds some overhead

## Cost Estimation

Based on Gemini pricing (check current rates):
- Gemini 2.5 Flash typical pricing: ~$0.00001875 per 1K tokens
- Daily AI news (3000 tokens): ~$0.056 per day
- Monthly estimate (30 days): ~$1.68

Note: Actual costs depend on current Gemini pricing and usage patterns.

## Optimization Tips

### Reduce Token Usage

1. **Limit Sources**: Use fewer news sources if token usage is high
2. **Shorter Summaries**: Truncate article summaries before sending to AI
3. **Batch Processing**: Consider processing news less frequently
4. **Cache Results**: Implement caching to avoid repeated API calls

### Monitor Efficiently

```bash
# Create daily token usage report
curl -s http://localhost:6005/api/v1/latest | jq '{
  timestamp: now | strftime("%Y-%m-%d %H:%M:%S"),
  type: .data.type,
  news_count: .data.selected_count,
  tokens: .data.token_usage,
  cost_estimate: (.data.token_usage.total_tokens * 0.00001875 / 1000)
}'
```

## Discord Token Display

The token usage appears in Discord as a footer embed:

```
ðŸ¤– Daily AI Tech News - January 4, 2025

1. OpenAI Announces GPT-5
[News content...]

2. Google's Quantum Breakthrough
[News content...]

[... more news items ...]

_Generated by AI News Bot powered by Gemini 2.5 Flash_
ðŸ“Š Token Usage: Input: 2456 | Output: 512 | Total: 2968
```

## API Response Example

```bash
curl -s http://localhost:6005/api/v1/latest | jq
```

Response includes token usage:
```json
{
  "message": "Latest news retrieved successfully",
  "data": {
    "news": [
      {
        "title": "Breaking AI News",
        "summary": "Important development in AI...",
        "url": "https://example.com",
        "source": "TechCrunch AI",
        "relevance": "Major breakthrough"
      }
    ],
    "generated_at": "2025-01-04T12:00:00Z",
    "scraped_count": 25,
    "selected_count": 5,
    "source_count": 5,
    "token_usage": {
      "input_tokens": 2456,
      "output_tokens": 512,
      "total_tokens": 2968
    }
  }
}
```

## Troubleshooting

### No Token Usage Data
If token usage is not displayed:
- Check Gemini API response includes usage metadata
- Verify you're using a compatible Gemini model version
- Check application logs for any errors

### High Token Usage
If token usage seems excessive:
- Review the number of news sources
- Check if article summaries are too long
- Consider implementing content length limits

### Cost Management
To manage API costs:
- Set up usage alerts in Google Cloud Console
- Implement daily/monthly token limits
- Use caching for frequently accessed data
- Monitor usage trends regularly

---

Token usage tracking helps you understand and optimize your AI API consumption while maintaining visibility into operational costs.